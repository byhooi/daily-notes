<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https:;">
    <title>每日积累 - 内容生成</title>
    
    <!-- Open Graph metadata -->
    <meta property="og:title" content="每日积累 - 内容生成">
    <meta property="og:description" content="文学之美，点滴汇聚。每日积累内容生成管理工具。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://daily.yangbing.eu.org/admin.html">
    <meta property="og:image" content="https://daily.yangbing.eu.org/assets/logo/logo.webp">
    <meta property="og:image:width" content="300">
    <meta property="og:image:height" content="300">
    
    <link rel="stylesheet" href="assets/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/common.css">
    <style>
        /* Admin-specific CSS variables */
        :root {
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --button-bg: #48bb78; /* Green button */
            --button-text: #ffffff;
            --button-hover-bg: #38a169; /* Darker green */
            --copy-button-bg: #4299e1; /* Blue button */
            --copy-button-hover-bg: #3182ce; /* Darker blue */
            --pre-bg: #edf2f7;
        }

        [data-theme="dark"] {
            --input-bg: #2d3748;
            --input-border: #4a5568;
            --button-bg: #68d391; /* Lighter green button */
            --button-hover-bg: #48bb78; /* Original green */
            --copy-button-bg: #63b3ed; /* Lighter blue button */
            --copy-button-hover-bg: #4299e1; /* Original blue */
            --pre-bg: #4a5568;
        }

        .highlight-red {
            color: #ff0000; /* 红色 */
        }

        body {
            font-family: 'LXGW WenKai', 'STKaiti', 'KaiTi', 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Droid Sans Fallback', 'Heiti SC', 'SimSun', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-color); /* Ensure text inside card uses theme color */
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            color: var(--secondary-color);
            background-color: var(--card-background); /* Match card background */
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            color: var(--accent-color);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* 6px */
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2); /* Accent color focus ring */
            border-color: var(--accent-color);
        }

        .form-label {
             display: block;
             font-weight: 500; /* medium */
             margin-bottom: 0.5rem; /* mb-2 */
             color: var(--text-color);
        }

        .btn {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.375rem; /* rounded */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            color: var(--button-text);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--button-bg);
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
        }
        .btn-secondary {
             background-color: var(--copy-button-bg);
        }
        .btn-secondary:hover {
             background-color: var(--copy-button-hover-bg);
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: var(--pre-bg);
            color: var(--text-color);
            padding: 1rem; /* p-4 */
            border-radius: 0.375rem; /* rounded */
            font-size: 0.875rem; /* text-sm */
            border: 1px solid var(--border-color);
        }

        /* Adjust header link color */
        header a {
            color: var(--accent-color);
            transition: color 0.2s ease;
        }
        header a:hover {
            filter: brightness(1.1);
        }

    </style>
</head>
<body class="min-h-screen py-8">
    <button class="theme-toggle p-2 rounded-full" onclick="toggleTheme()">
        <i class="fas fa-sun text-yellow-500"></i>
    </button>

    <div class="container mx-auto px-4 max-w-4xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">内容生成</h1>
            <a href="index.html" class="text-lg">返回首页</a>
        </header>

        <!-- 添加表单 -->
        <div class="card rounded-lg p-6 mb-8" style="opacity: 1; transform: translateY(0);">
            <form id="entryForm" class="space-y-6">
                <div>
                    <label for="dateInput" class="form-label">日期</label>
                    <input type="date" id="dateInput" class="form-input" required>
                </div>
                <div>
                    <label for="titleInput" class="form-label">标题（选填）</label>
                    <input type="text" id="titleInput" class="form-input" placeholder="请输入标题（可选）">
                </div>
                <div>
                    <label for="contentInput" class="form-label">内容（每行一个条目）</label>
                    
                    <!-- 功能提示 -->
                    <div class="mb-3 p-3 rounded-lg" style="background-color: var(--pre-bg); border: 1px solid var(--border-color);">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-info-circle mr-2" style="color: var(--accent-color);"></i>
                            <span class="font-medium">文字标红功能</span>
                        </div>
                        <p class="text-sm mb-2">使用 <code class="px-1 py-0.5 rounded text-xs" style="background-color: var(--input-bg); border: 1px solid var(--input-border);">##文字##</code> 格式将文字标记为红色</p>
                        <div class="text-xs opacity-75">
                            示例：这是一个##重要##的词汇 → 这是一个<span class="highlight-red">重要</span>的词汇
                        </div>
                    </div>
                    
                    <textarea id="contentInput" class="form-input h-48" required placeholder="输入内容，每行一个条目...&#10;例如：今天天气很好，##阳光明媚##，适合外出游玩。"></textarea>
                    <div class="mt-4">
                        <button type="button" onclick="generateArrayItem()" class="btn btn-primary">
                            <i class="fas fa-cogs mr-1"></i> 生成内容
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 预览区域 -->
        <div class="card rounded-lg p-6" style="opacity: 1; transform: translateY(0);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">数组内容预览</h2>
                <button onclick="copyContent()" class="btn btn-secondary">
                    <i class="fas fa-copy mr-1"></i> 复制内容
                </button>
            </div>
            <pre id="previewArea"></pre>
        </div>
    </div>

    <script>
        // 获取元素
        const form = document.getElementById('entryForm');
        const dateInput = document.getElementById('dateInput');
        const titleInput = document.getElementById('titleInput');
        const contentInput = document.getElementById('contentInput');
        const previewArea = document.getElementById('previewArea');

        // HTML 转义函数，防止 XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 新增：辅助函数，处理高亮标记和全角转换
        function processLineForHighlightingAndFullWidth(line, toFullWidthFunc) {
            const parts = line.split(/(##.*?##)/g); // 按 ##标记## 分割，并保留标记部分
            let processedLine = "";
            for (const part of parts) {
                if (part.startsWith("##") && part.endsWith("##")) {
                    const highlightedText = part.substring(2, part.length - 2); // 提取标记内的文本
                    // 转义 HTML 后再包裹在 span 中
                    processedLine += `<span class='highlight-red'>${escapeHtml(toFullWidthFunc(highlightedText))}</span>`;
                } else {
                    processedLine += escapeHtml(toFullWidthFunc(part)); // 对非标记部分转义并应用全角转换
                }
            }
            return processedLine;
        }

        // 生成数组项
        function generateArrayItem() {
            const lines = contentInput.value.split('\n').filter(line => line.trim());
            if (!dateInput.value) {
                 alert('请选择日期！');
                 dateInput.focus();
                 return;
            }
            if (lines.length === 0) {
                alert('请输入内容！');
                contentInput.focus();
                return;
            }

            // 半角转全角函数（保留数字和字母为半角，并在中英文/数字之间添加空格）
            function toFullWidth(str) {
                let result = "";

                // 辅助函数：判断是否为数字或英文字母
                function isAlphaNum(charCode) {
                    return (charCode >= 48 && charCode <= 57) ||  // 数字 0-9
                           (charCode >= 65 && charCode <= 90) ||  // 大写字母 A-Z
                           (charCode >= 97 && charCode <= 122);   // 小写字母 a-z
                }

                // 辅助函数：判断是否为中文字符
                function isChinese(charCode) {
                    return (charCode >= 0x4E00 && charCode <= 0x9FFF) ||  // 基本汉字
                           (charCode >= 0x3400 && charCode <= 0x4DBF) ||  // 扩展A
                           (charCode >= 0x20000 && charCode <= 0x2A6DF);  // 扩展B
                }

                for (let i = 0; i < str.length; i++) {
                    const charCode = str.charCodeAt(i);
                    const char = str[i];
                    const prevCharCode = i > 0 ? str.charCodeAt(i - 1) : null;
                    const nextCharCode = i < str.length - 1 ? str.charCodeAt(i + 1) : null;

                    // 保留数字 0-9 和字母 A-Z, a-z 为半角
                    if (isAlphaNum(charCode)) {
                        // 如果前一个字符是中文，且当前结果不以空格结尾，添加空格
                        if (prevCharCode && isChinese(prevCharCode) && !result.endsWith(' ')) {
                            result += ' ';
                        }
                        result += char;
                        // 如果下一个字符是中文，标记需要在后面加空格
                        if (nextCharCode && isChinese(nextCharCode)) {
                            result += ' ';
                        }
                    } else if (charCode > 32 && charCode < 127) {
                        // 只转换标点符号为全角
                        const punctuationMap = {
                            "!": "！", '"': '"', "#": "＃", "$": "＄", "%": "％", "&": "＆",
                            "'": "'", "(": "（", ")": "）", "*": "＊", "+": "＋", ",": "，",
                            "-": "－", ".": "．", "/": "／", ":": "：", ";": "；", "<": "＜",
                            "=": "＝", ">": "＞", "?": "？", "@": "＠", "[": "［", "\\": "＼",
                            "]": "］", "^": "＾", "_": "＿", "`": "｀", "{": "｛", "|": "｜",
                            "}": "｝", "~": "～"
                        };
                        result += punctuationMap[char] || char; // 如果不在映射中，保持原样
                    } else {
                        result += char;
                    }
                }
                return result;
            }

            let content;
            if (lines.length === 1) {
                // 使用新函数处理单行内容
                const processedSingleLine = processLineForHighlightingAndFullWidth(lines[0], toFullWidth);
                content = `"${processedSingleLine.replace(/"/g, '\\"').replace(/`/g, '\\`')}"`;
            } else {
                // 使用新函数处理多行内容
                const escapedLines = lines.map(line => `              <li>${processLineForHighlightingAndFullWidth(line, toFullWidth).replace(/`/g, '\\`')}</li>`).join('\n');
                content = `\`<ol class="list-decimal list-inside space-y-2">\n${escapedLines}\n            </ol>\``;
            }

            const parts = [
                `{`,
                `    date: "${dateInput.value}",`
            ];

            if (titleInput.value.trim()) {
                // 对标题也应用全角转换
                parts.push(`    title: "${toFullWidth(titleInput.value).replace(/"/g, '\\"')}",`);
            }

            parts.push(
                `    content: ${content}`,
                `  }`
            );

            previewArea.textContent = parts.join('\n');
        }

        // 复制内容到剪贴板
        function copyContent() {
            const content = previewArea.textContent;
            if (!content) {
                alert('请先生成内容！');
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                alert('内容已复制到剪贴板！');
                // Optional: Add visual feedback like changing button text/icon
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制。');
            });
        }

        // 深色模式切换
        function toggleTheme() {
            const theme = document.documentElement.getAttribute('data-theme');
            const newTheme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme); // Save preference
            updateThemeIcon(newTheme);
        }

        // 更新主题图标
        function updateThemeIcon(theme) {
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.innerHTML = ''; // Clear existing icon
            const icon = document.createElement('i');
            icon.classList.add('fas');
            if (theme === 'dark') {
                icon.classList.add('fa-moon', 'text-blue-300'); // Moon icon for dark
            } else {
                icon.classList.add('fa-sun', 'text-yellow-500'); // Sun icon for light
            }
            themeToggle.appendChild(icon);
        }


        // 检查系统/本地存储颜色模式并设置初始主题和图标
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }


        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme(); // Set theme on load
            // Set default date
            if (!dateInput.value) {
                 dateInput.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
